#!/usr/bin/env ruby

require 'spacefind'
require 'slop'

opts = Slop.parse do |o|
  o.string '-d', '--dir', 'Search an alternate directory (default: CWD)'
  o.bool '-u', '--unlimited', 'Search all files (default: only search .php files)'
  o.bool '-q', '--quiet', 'Suppress all non-essential output'
  o.on '-h', '--help', 'Show this help message' do
    puts o
    exit
  end
  o.on '--version', 'Print version' do
    puts Spacefind::VERSION
    exit
  end
end

pattern = '**/*'
pattern = File.join(opts[:dir], pattern) unless opts[:dir].nil?
pattern += '.php' unless opts.unlimited?

puts "Searching #{pattern} for problems..." unless opts.quiet?

Dir.glob(pattern) do |f|
  next unless File.file?(f)
  next unless Spacefind.problematic?(f)

  puts "Potentially problematic file: #{f}"
end

puts "Done." unless opts.quiet?
